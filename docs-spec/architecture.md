<!-- このドキュメントは実装の正です。変更時は実装も同期すること -->

# architecture.md

jamjamの技術構成を定義する。本ドキュメントは実装の正とする。

---

## 1. システム概要

### 1.1 目的

ミュージシャンがインターネット越しにリアルタイムで演奏セッションを行うための、P2P音声通信を実現する。アプリケーション起因の片道遅延 < 10ms を目標とする（セクション11参照）。

### 1.2 設計原則

- アプリケーション起因の遅延を最小化する（目標: 片道 < 10ms）
- 音声信号に余計な処理を加えない（ピュアな音声伝送）
- プリセット選択のみで動作開始可能、上級者は詳細パラメータを設定可能

---

## 2. 対応プラットフォーム

| プラットフォーム | 対応状況 | GUI フレームワーク |
|-----------------|----------|-------------------|
| Windows | Phase 1 | Tauri 2.0 |
| macOS | Phase 1 | Tauri 2.0 |
| Linux | Phase 1 | Tauri 2.0 |
| iOS | Phase 5 | Flutter |
| Android | Phase 5 | Flutter |

---

## 3. 技術スタック

### 3.1 言語

| 用途 | 言語 |
|------|------|
| コアエンジン | Rust (stable) |
| デスクトップGUI | TypeScript (Tauri 2.0) |
| モバイルGUI | Dart (Flutter) |
| シグナリングサーバー | Rust |

### 3.2 主要ライブラリ

| 機能 | ライブラリ | 状態 |
|------|-----------|------|
| 音声I/O | cpal | 実装済 |
| リングバッファ | ringbuf | 実装済 |
| 非同期ランタイム | tokio | 実装済 |
| シリアライズ | bincode | 実装済 |
| ロギング | tracing | 実装済 |
| エラー処理 | thiserror | 実装済 |
| GUI（デスクトップ） | Tauri 2.0 | 実装済 |
| 音声コーデック（Opus） | opus-rs | 予定 |
| 音声コーデック（FLAC） | claxon | 予定 |
| GUI（モバイル） | Flutter + flutter_rust_bridge | 予定 |

### 3.3 実装済みモジュール構成

```
src/
├── audio/
│   ├── device.rs       # デバイス列挙
│   ├── effects.rs      # エフェクト（Gain, Filter, Compressor, Delay, Gate）
│   ├── engine.rs       # オーディオエンジン
│   ├── error.rs        # エラー型
│   ├── metronome.rs    # メトロノーム
│   ├── plugin.rs       # プラグインホスト
│   └── recording.rs    # WAV録音
├── network/
│   ├── error.rs        # ネットワークエラー
│   ├── fec.rs          # 前方誤り訂正
│   ├── protocol.rs     # jamjamプロトコル
│   ├── session.rs      # セッション管理
│   ├── signaling.rs    # シグナリング
│   ├── stun.rs         # STUN クライアント
│   └── transport.rs    # UDPトランスポート
├── lib.rs
└── main.rs

src-tauri/              # Tauri デスクトップアプリ
ui/dist/                # フロントエンドUI
```

---

## 4. 音声サブシステム

### 4.1 オーディオI/O

| プラットフォーム | バックエンド |
|-----------------|-------------|
| macOS | CoreAudio |
| Windows | WASAPI（標準）、ASIO（対応インターフェース使用時） |
| Linux | PipeWire（優先）、ALSA（フォールバック） |

### 4.2 音声フォーマット

| パラメータ | 選択肢 | デフォルト |
|-----------|--------|-----------|
| サンプルレート | 44100 / 48000 / 96000 Hz | 48000 Hz |
| ビット深度 | 16 / 24 / 32 (float) bit | 24 bit |
| チャンネル数 | 1（モノラル）/ 2（ステレオ）/ N（マルチ） | 1 |
| フレームサイズ | 64 / 128 / 256 / 512 / 1024 samples | 128 samples |

### 4.3 コーデック

| コーデック | 用途 | ビットレート | 遅延特性 |
|-----------|------|-------------|---------|
| 非圧縮PCM | LAN内、コーデック起因遅延 0ms | 約1.5 Mbps/ch (48kHz/16bit) | 最小 |
| Opus | インターネット越し | 64-256 kbps | 低（2.5ms フレーム対応） |
| FLAC | 録音用、ロスレス品質 | 可変（約800 kbps/ch） | 中 |

### 4.4 音声処理

原則として音声処理は行わない。

| 処理 | 実装 | 理由 |
|------|------|------|
| エコーキャンセル（AEC） | なし | ヘッドホン使用を前提 |
| ノイズ抑制 | なし | ピュアな音声伝送を優先 |
| 自動ゲイン制御（AGC） | なし | 同上 |

---

## 5. ネットワークサブシステム

### 5.1 プロトコル構成

```
+------------------+
|   Application    |
+------------------+
|   Audio Codec    |
+------------------+
|  jamjam Protocol |  <- カスタムUDPプロトコル
+------------------+
|   DTLS (optional)|  <- 暗号化レイヤー
+------------------+
|       UDP        |
+------------------+
|       IP         |
+------------------+
```

### 5.2 jamjam Protocol

カスタムUDPプロトコルを使用する。

**パケットヘッダ（12バイト）:**

| フィールド | サイズ | 説明 |
|-----------|-------|------|
| version | 1 byte | プロトコルバージョン |
| type | 1 byte | パケットタイプ |
| sequence | 4 bytes | シーケンス番号 |
| timestamp | 4 bytes | タイムスタンプ（サンプル単位） |
| flags | 2 bytes | フラグ（FEC、暗号化等） |

**パケットタイプ:**

| 値 | タイプ | 説明 |
|----|-------|------|
| 0x01 | AUDIO | 音声データ |
| 0x02 | FEC | FEC冗長データ |
| 0x03 | CONTROL | 制御メッセージ |
| 0x04 | KEEPALIVE | 接続維持 |

### 5.3 NAT越え

| 方式 | 用途 |
|------|------|
| STUN | パブリックIP/ポートの取得 |
| TURN | STUNで接続不可の場合のリレー |
| ICE | NAT越え手順の自動化 |

公開STUNサーバーを利用可能とする。TURNサーバーは自前で運用する。

### 5.4 暗号化

| 項目 | 仕様 |
|------|------|
| 方式 | DTLS 1.3 |
| デフォルト | ON |
| ユーザー設定 | OFF可能（アドバンスオプション） |

暗号化によるレイテンシ増加は無視できるレベル（数マイクロ秒）である。

### 5.5 パケットロス対策

**FEC（前方誤り訂正）:**

| 項目 | 仕様 |
|------|------|
| 方式 | Reed-Solomon または XOR ベース |
| 冗長度 | 設定可能（デフォルト: 10%） |
| 遅延影響 | 1フレーム分 |

再送は行わない（リアルタイム性を優先）。

### 5.6 Jitterバッファ

| 項目 | 仕様 |
|------|------|
| 方式 | 適応的 |
| 最小サイズ | ユーザー設定可能（デフォルト: 1フレーム） |
| 最大サイズ | 設定可能（デフォルト: 10フレーム） |
| 適応速度 | ネットワーク状況に応じて自動調整 |

### 5.7 帯域適応

| 項目 | 仕様 |
|------|------|
| 帯域推定 | パケットロス率、RTTに基づく |
| 適応動作 | コーデックビットレートの動的変更 |
| ユーザー制御 | 自動/手動切替可能 |

---

## 6. シグナリング

### 6.1 概要

P2P接続確立のためのシグナリングサーバーを提供する。

### 6.2 プロトコル

| 項目 | 仕様 |
|------|------|
| トランスポート | WebSocket over TLS |
| フォーマット | JSON |
| 認証 | なし（初期）、OAuth2（将来） |

### 6.3 ホスティング

| 項目 | 仕様 |
|------|------|
| 初期 | VPS（自前運用） |
| 将来 | Cloudflare Workers検討 |

---

## 7. セッション管理

### 7.1 ルーム

| 項目 | 仕様 |
|------|------|
| ルームID | UUID v4 |
| 招待方式 | URL、招待コード（6文字英数字） |
| パスワード | オプション（SHA-256ハッシュ保存） |
| 最大参加者 | 10人以上（P2Pメッシュの限界まで） |

### 7.2 接続トポロジ

| 参加者数 | トポロジ |
|---------|---------|
| 2人 | 直接P2P |
| 3人以上 | フルメッシュP2P |

10人のフルメッシュでは各クライアントが9本の接続を維持する。

### 7.3 直接接続（アドバンスオプション）

シグナリングサーバーを介さず、IPアドレスとポートを直接指定して接続する機能を提供する。

---

## 8. ユーザーインターフェース

### 8.1 GUI

Tauri 2.0を使用したデスクトップGUIを提供する。

**必須画面:**

| 画面 | 機能 |
|------|------|
| メイン | セッション参加/作成、接続状態表示 |
| ミキサー | 各参加者の音量調整、ミュート |
| 設定 | オーディオデバイス、プリセット、詳細設定 |
| 接続情報 | レイテンシ、パケットロス率、帯域表示 |

### 8.2 CLI

全機能をCLIから利用可能とする。E2Eテストの自動化に対応する。

**主要コマンド:**

```
jamjam host [--port PORT] [--password PASS]
jamjam join <ROOM_URL|IP:PORT>
jamjam devices list
jamjam devices set --input <ID> --output <ID>
jamjam preset list
jamjam preset use <NAME>
jamjam preset save <NAME>
```

### 8.3 プリセット

| プリセット名 | Jitterバッファ | コーデック | フレームサイズ | 用途 |
|-------------|---------------|-----------|--------------|------|
| ultra-low-latency | 1フレーム | 非圧縮PCM | 64 samples | LAN内ジャム |
| balanced | 4フレーム | Opus 128kbps | 128 samples | 一般的なネット環境 |
| high-quality | 8フレーム | Opus 256kbps | 256 samples | 録音・高速回線 |

ユーザーはプリセットをベースにカスタマイズし、名前を付けて保存できる。

---

## 9. 追加機能（Phase 4以降）

### 9.1 仮想オーディオデバイス

ミックスされた音声出力を仮想オーディオデバイスとして提供し、DAWや配信ソフトで利用可能とする。

| プラットフォーム | 実装方式 |
|-----------------|---------|
| macOS | Core Audio HAL plugin |
| Windows | Virtual Audio Cable互換ドライバ |
| Linux | PipeWire/JACK仮想デバイス |

### 9.2 録音機能

セッション全体または個別トラックを録音する。

| 項目 | 仕様 |
|------|------|
| フォーマット | WAV、FLAC |
| トラック | ミックス、個別（マルチトラック） |
| 保存先 | ローカルファイル |

### 9.3 メトロノーム共有

ホストがメトロノームを開始し、全参加者に同期配信する。

| 項目 | 仕様 |
|------|------|
| BPM範囲 | 20-300 |
| 拍子 | 設定可能（4/4、3/4等） |
| 同期方式 | タイムスタンプベース |

### 9.4 エフェクト

内蔵エフェクトを提供する。

| エフェクト | 説明 | パラメータ |
|-----------|------|-----------|
| Gain | 音量調整 | gain_db: dB値 |
| LowPassFilter | 低域通過フィルタ | cutoff_hz: カットオフ周波数 |
| HighPassFilter | 高域通過フィルタ | cutoff_hz: カットオフ周波数 |
| Compressor | ダイナミクス圧縮 | threshold_db, ratio, attack_ms, release_ms, makeup_db |
| Delay | ディレイ | delay_ms, feedback, mix |
| NoiseGate | ノイズゲート | threshold_db, attack_ms, release_ms |

エフェクトはEffectChainで順序処理される。各エフェクトは個別に有効/無効切替可能。

### 9.5 プラグイン対応

外部オーディオプラグインのホスト機能を提供する。

| 規格 | 対応状況 | 備考 |
|------|---------|------|
| VST3 | インターフェース実装済 | プラグインロード機能は別途実装 |
| CLAP | インターフェース実装済 | MITライセンス互換 |
| AU | インターフェース実装済 | macOSのみ |

**プラグイン検索パス:**

| プラットフォーム | パス |
|-----------------|------|
| Linux | ~/.vst3, /usr/lib/vst3, ~/.clap, /usr/lib/clap |
| macOS | /Library/Audio/Plug-Ins/VST3, ~/Library/Audio/Plug-Ins/VST3, Components |
| Windows | C:\Program Files\Common Files\VST3, CLAP |

---

## 10. スレッドモデル

### 10.1 スレッド構成

| スレッド | 優先度 | 役割 |
|---------|--------|------|
| Audio Capture | リアルタイム | 音声入力の取得 |
| Audio Playback | リアルタイム | 音声出力の再生 |
| Network Send | 高 | パケット送信 |
| Network Receive | 高 | パケット受信 |
| Jitter Buffer | 高 | バッファ管理 |
| GUI | 通常 | ユーザーインターフェース |
| Signaling | 通常 | シグナリング通信 |

### 10.2 リアルタイム制約

Audio Capture/Playbackスレッドでは以下を禁止する:

- メモリアロケーション
- ブロッキングI/O
- ミューテックスの長時間保持
- システムコール（可能な限り）

---

## 11. 遅延バジェット

アプリケーション起因の遅延を以下に収める（48kHz、128samples時）:

| 処理 | 目標遅延 |
|------|---------|
| 音声キャプチャバッファ | 2.67 ms (128 samples) |
| エンコード | < 0.5 ms |
| パケット化 | < 0.1 ms |
| 送信バッファ | < 0.5 ms |
| --- ネットワーク伝送 --- | （別途） |
| 受信バッファ | < 0.5 ms |
| Jitterバッファ | 2.67 ms (最小、1フレーム) |
| デコード | < 0.5 ms |
| 再生バッファ | 2.67 ms (128 samples) |
| **合計（片道、アプリ起因）** | **< 10 ms** |

ネットワーク遅延はRTT/2として加算される。

---

## 12. エラーハンドリング

### 12.1 接続断

| 状況 | 動作 |
|------|------|
| 一時的な切断（< 5秒） | 自動再接続試行 |
| 長時間切断（≥ 5秒） | ユーザーに通知、手動再接続 |
| シグナリングサーバー断 | P2P接続は維持、新規参加不可 |

### 12.2 音声デバイスエラー

| 状況 | 動作 |
|------|------|
| デバイス切断 | デフォルトデバイスにフォールバック |
| デバイス再接続 | ユーザーに通知、手動切替 |

---

## 13. 設定ファイル

### 13.1 保存場所

| プラットフォーム | パス |
|-----------------|------|
| Windows | `%APPDATA%\jamjam\config.toml` |
| macOS | `~/Library/Application Support/jamjam/config.toml` |
| Linux | `~/.config/jamjam/config.toml` |

### 13.2 フォーマット

TOML形式を使用する。

---

## 14. ビルド・配布

### 14.1 ビルドシステム

| 項目 | ツール |
|------|--------|
| Rustビルド | Cargo |
| GUIビルド | Tauri CLI |
| CI/CD | GitHub Actions |

### 14.2 配布形式

| プラットフォーム | 形式 |
|-----------------|------|
| Windows | MSIインストーラー、ポータブルZIP |
| macOS | DMG、Homebrew Cask |
| Linux | AppImage、deb、rpm |

---

## 15. 国際化（i18n）

### 15.1 対応言語

| 言語 | コード | ステータス |
|------|--------|-----------|
| 日本語 | ja | 初期対応 |
| 英語 | en | 初期対応 |

### 15.2 実装

| プラットフォーム | ライブラリ | 翻訳ファイル形式 |
|-----------------|-----------|-----------------|
| デスクトップ（Tauri） | i18next | JSON |
| モバイル（Flutter） | flutter_localizations + intl | ARB |

### 15.3 翻訳ファイル配置

| プラットフォーム | パス |
|-----------------|------|
| デスクトップ | ui/locales/{lang}.json |
| モバイル | lib/l10n/app_{lang}.arb |

### 15.4 言語検出

| 優先順位 | 方法 |
|---------|------|
| 1 | config.toml の language 設定 |
| 2 | システムロケール（OS設定） |
| 3 | 英語（フォールバック） |

### 15.5 フォールバック動作

翻訳キーが見つからない場合:
1. 英語の翻訳を使用
2. 英語も存在しない場合はキー自体を表示
3. コンソールに警告を出力

### 15.6 翻訳キー命名規則

形式: `{namespace}.{section}.{element}`

| 名前空間 | 対象 | 例 |
|---------|------|-----|
| session | セッション管理 | session.create, session.leave |
| audio | 音声設定 | audio.device.input, audio.start |
| mixer | ミキサー | mixer.you, mixer.mute |
| settings | 設定画面 | settings.language, settings.preset |
| status | 接続状態 | status.connected, status.disconnected |
| error | エラー | error.connection.timeout |
