Feature: セッション接続
  ミュージシャンがjamjamを使用してセッションに接続する

  Background:
    Given jamjamアプリケーションが起動している
    And オーディオデバイスが正常に認識されている

  # ルーム作成
  Scenario: ルームを作成する
    When ユーザーが「ルーム作成」を選択する
    Then 新しいルームIDが生成される
    And 招待URL（例: jamjam://join/abc123）が表示される
    And 招待コード（6文字英数字）が表示される
    And ユーザーはホストとしてルームに参加している

  Scenario: パスワード付きルームを作成する
    When ユーザーが「ルーム作成」を選択する
    And パスワード「secret123」を設定する
    Then パスワード保護されたルームが作成される
    And 招待URLにはパスワードが含まれない

  # ルーム参加
  Scenario: 招待URLでルームに参加する
    Given ホストがルームを作成済み
    When ユーザーが招待URL「jamjam://join/abc123」を開く
    Then ルームへの接続が開始される
    And 接続成功後、セッション画面が表示される

  Scenario: 招待コードでルームに参加する
    Given ホストがルームを作成済み
    When ユーザーが招待コード「ABC123」を入力する
    Then ルームへの接続が開始される
    And 接続成功後、セッション画面が表示される

  Scenario: パスワード付きルームに参加する
    Given ホストがパスワード「secret123」でルームを作成済み
    When ユーザーが招待URLを開く
    Then パスワード入力画面が表示される
    When ユーザーがパスワード「secret123」を入力する
    Then ルームへの接続が成功する

  Scenario: 誤ったパスワードでルームに参加しようとする
    Given ホストがパスワード「secret123」でルームを作成済み
    When ユーザーが招待URLを開く
    And パスワード「wrong」を入力する
    Then 「パスワードが正しくありません」とエラーが表示される
    And ルームには接続されない

  # 直接接続（アドバンスオプション）
  Scenario: IPアドレスで直接接続する
    Given ホストがポート5000でリッスンしている
    When ユーザーがアドバンスオプションを開く
    And IPアドレス「192.168.1.100」とポート「5000」を入力する
    And 「直接接続」を選択する
    Then シグナリングサーバーを経由せずに接続される

  # 切断
  Scenario: セッションから退出する
    Given ユーザーがセッションに参加している
    When ユーザーが「退出」を選択する
    Then セッションから切断される
    And メイン画面に戻る
    And 他の参加者に退出が通知される

  Scenario: ホストがセッションを終了する
    Given ホストとしてセッションを作成済み
    And 他に2名の参加者がいる
    When ホストが「セッション終了」を選択する
    Then 全参加者に「ホストがセッションを終了しました」と通知される
    And 全員がセッションから切断される

  # 再接続
  Scenario: 一時的なネットワーク切断から自動再接続する
    Given ユーザーがセッションに参加している
    When ネットワークが3秒間切断される
    Then 自動再接続が試行される
    And 再接続成功後、セッションが継続される

  Scenario: 長時間のネットワーク切断
    Given ユーザーがセッションに参加している
    When ネットワークが10秒間切断される
    Then 「接続が切断されました。再接続しますか？」と表示される
    And ユーザーが「再接続」を選択すると再接続が試行される

  # 参加者管理
  Scenario: 新しい参加者がセッションに参加する
    Given ホストとしてセッションを作成済み
    When 新しい参加者がルームに参加する
    Then ホストに「○○さんが参加しました」と通知される
    And ミキサーに新しい参加者のチャンネルが追加される

  Scenario: 最大参加者数に達している場合
    Given セッションに10名が参加している
    And 最大参加者数が10名に設定されている
    When 11人目が参加しようとする
    Then 「ルームが満員です」とエラーが表示される
    And 参加は拒否される
