# Docker Compose configuration for jamjam (Ansible managed)
# This file is auto-generated by Ansible. Do not edit manually.

services:
  # Cloudflare Tunnel - handles TLS termination
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: jamjam-cloudflared
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
    networks:
      - jamjam-network
    depends_on:
      signaling-server:
        condition: service_healthy

  # Signaling server - WebSocket for room management and ICE exchange
  signaling-server:
    image: jamjam-signaling:{{ jamjam_image_tag }}
    container_name: jamjam-signaling
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
    restart: unless-stopped
    networks:
      - jamjam-network
    logging:
      driver: json-file
      options:
        max-size: "{{ docker_log_max_size }}"
        max-file: "{{ docker_log_max_file }}"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "signaling"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # Echo server - returns audio with configurable delay
  echo-server:
    image: jamjam-echo:{{ jamjam_image_tag }}
    container_name: jamjam-echo
    ports:
      - "5000:5000/udp"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - ECHO_DELAY_MS=${ECHO_DELAY_MS:-3000}
      - SIGNALING_URL=ws://signaling-server:8080
      - PUBLIC_ADDR=${ECHO_PUBLIC_ADDR:-}
    command: ["--port", "5000", "--signaling-url", "ws://signaling-server:8080"]
    restart: unless-stopped
    networks:
      - jamjam-network
    depends_on:
      signaling-server:
        condition: service_healthy
    logging:
      driver: json-file
      options:
        max-size: "{{ docker_log_max_size }}"
        max-file: "{{ docker_log_max_file }}"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "echo"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

networks:
  jamjam-network:
    driver: bridge
