---
# jamjam service deployment tasks
# Deploys locally-built Docker images via SSH transfer

- name: Create application directory
  file:
    path: "{{ jamjam_app_dir }}"
    state: directory
    mode: '0755'

- name: Create docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ jamjam_app_dir }}/docker-compose.yml"
    mode: '0644'
  notify: Restart jamjam services

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ jamjam_app_dir }}/.env"
    owner: "{{ ansible_user }}"
    group: docker
    mode: '0640'
  notify: Restart jamjam services

# Transfer locally-built Docker images
- name: Check if local image archive exists
  delegate_to: localhost
  become: no
  stat:
    path: /tmp/jamjam-images.tar.gz
  register: local_image_archive

- name: Copy Docker images to server
  copy:
    src: /tmp/jamjam-images.tar.gz
    dest: /tmp/jamjam-images.tar.gz
    mode: '0644'
  when: local_image_archive.stat.exists

- name: Load Docker images
  shell: gunzip -c /tmp/jamjam-images.tar.gz | docker load
  register: load_result
  changed_when: "'Loaded image' in load_result.stdout"
  when: local_image_archive.stat.exists

- name: Clean up image archive on server
  file:
    path: /tmp/jamjam-images.tar.gz
    state: absent
  when: local_image_archive.stat.exists

# Pull cloudflared from public registry
- name: Pull cloudflared image
  command: docker pull cloudflare/cloudflared:latest
  args:
    chdir: "{{ jamjam_app_dir }}"
  register: pull_result
  changed_when: "'Pull complete' in pull_result.stdout or 'Downloaded' in pull_result.stdout"

- name: Start jamjam services
  command: docker compose up -d
  args:
    chdir: "{{ jamjam_app_dir }}"
  register: compose_result
  changed_when: "'Started' in compose_result.stdout or 'Created' in compose_result.stdout"

- name: Wait for services to be healthy
  command: docker compose ps --format json
  args:
    chdir: "{{ jamjam_app_dir }}"
  register: compose_status
  until: compose_status.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Display service status
  debug:
    msg: "Services started. Check status with: docker compose ps"
